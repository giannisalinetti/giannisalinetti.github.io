---
import { WebsiteLinks } from "../consts";
import ThemeToggle from "./ThemeToggle.astro";
import { Image } from "astro:assets";
import logoPng from "../assets/logo.png";

const { pathname } = Astro.url;

function isActive(href: string): boolean {
  if (href === "/") return pathname === "/";
  return pathname.startsWith(href);
}
---

<header class="fixed top-0 w-full z-40 bg-background dark:bg-background-dark border-b border-foreground/5 dark:border-foreground-dark/5">
  <nav>
    <div class="app-container flex justify-between items-center py-5">
      <a href="/" aria-label="Home">
        <Image src={logoPng} alt="Logo" class="h-9 w-auto dark:invert" width={36} height={36} />
      </a>
      <div class="gap-8 hidden md:flex items-center">
        {WebsiteLinks.map((link) => (
          <a
            href={link.url}
            class:list={[
              "text-lg underline-offset-4 hover:underline decoration-2 transition-colors",
              isActive(link.url) && "underline text-primary dark:text-primary-dark",
            ]}
          >
            {link.name}
          </a>
        ))}
        <ThemeToggle />
      </div>
      <button
        class="md:hidden cursor-pointer p-1"
        id="nav-open-btn"
        aria-label="Open navigation menu"
      >
        <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <!-- Mobile nav -->
      <div
        class="translate-x-full md:hidden fixed top-0 right-0 bg-background dark:bg-background-dark h-screen w-5/6 px-8 py-6 transition-transform z-40 border-l border-foreground/10 dark:border-foreground-dark/10"
        id="mobile-menu"
      >
        <button
          id="nav-close-btn"
          class="ml-auto block cursor-pointer p-1"
          aria-label="Close navigation menu"
        >
          <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="flex flex-col h-full items-start gap-8 pt-16">
          {WebsiteLinks.map((link) => (
            <a
              href={link.url}
              class:list={[
                "text-4xl font-light underline-offset-4 hover:underline decoration-2",
                isActive(link.url) && "underline text-primary dark:text-primary-dark",
              ]}
            >
              {link.name}
            </a>
          ))}
          <ThemeToggle class="mt-4" />
        </div>
      </div>
    </div>
  </nav>

  <script>
    function toggleNav() {
      document.querySelector("#mobile-menu")?.classList.toggle("mobile-nav-open");
    }
    document.querySelector("#nav-open-btn")?.addEventListener("click", toggleNav);
    document.querySelector("#nav-close-btn")?.addEventListener("click", toggleNav);
  </script>
</header>

<script is:inline>
  function reComputeTheme() {
    if (
      localStorage.theme === "dark" ||
      (!("theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
    const theme = localStorage.theme || "auto";
    document
      .querySelectorAll(`[data-theme="theme-${theme}"]`)
      .forEach((el) => el.classList.add("active"));
  }

  function addThemeEventListeners() {
    const themeButtons = document.querySelectorAll(".theme-button");
    themeButtons.forEach((button) => {
      button.addEventListener("click", () => {
        themeButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        if (button.dataset.theme === "theme-auto") {
          localStorage.removeItem("theme");
          reComputeTheme();
        } else {
          localStorage.theme = button.dataset.theme.replace("theme-", "");
          document.documentElement.classList.toggle(
            "dark",
            button.dataset.theme === "theme-dark"
          );
        }
      });
    });
  }

  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
    reComputeTheme();
  });

  window.matchMedia("(min-width: 768px)").addEventListener("change", () => {
    addThemeEventListeners();
    reComputeTheme();
  });

  reComputeTheme();

  window.addEventListener("DOMContentLoaded", () => {
    addThemeEventListeners();
    reComputeTheme();
  });
</script>
